- id: leave_for work_action
  alias: his_leave_for work_action
  initial_state: True
  trigger:
  - platform: state
    entity_id: input_select.josh_status
    to: 'Away'
  condition:
  - condition: state
    entity_id: input_boolean.ib_m_status_sleeping
    state: 'on'
  action:
  - service: scene.turn_on
    entity_id: scene.s_leave_for_work_action

############PRESENSE############
- id: just_arrived
  alias: Mark person as just arrived
  initial_state: True
  trigger:
  - platform: state
    entity_id: person.josh
    from: not_home
    to: home
  - platform: state
    entity_id: person.mj
    from: not_home
    to: home
  action:
  - service: input_select.select_option
    data_template:
      entity_id: >
        {% if trigger.entity_id == 'person.josh' %}
          input_select.josh_status
        {% else %}
          input_select.mj_status
        {% endif %}
      option: >
        {% if trigger.entity_id == 'person.josh' %}
          {% if states.input_select.josh_status.state == 'Just Left' %}
            Home
          {% else %}
            Just Arrived
          {% endif %}
        {% else %}
          {% if states.input_select.mj_status.state == 'Just Left' %}
          Home
          {% else %}
          Just Arrived
          {% endif %}
        {% endif %}
#  - service: notify.josh
#    data_template:
#      title: Just Arrived NEW
#      message:  >
#        {% if states('input_select.josh_status') == 'Just Arrived'%}
#          Josh's status is {{states.input_select.josh_status.state}} {{now().strftime('%H:%M-%d%b')}}
#        {% else %}
#          MJ's status is {{states.input_select.mj_status.state}} {{now().strftime('%H:%M-%d%b')}}
#        {% endif %}

- id: person_home
  alias: Mark person as home
  initial_state: True
  trigger:
  - platform: state
    entity_id: input_select.josh_status
    to: 'Just Arrived'
    for:
      minutes: 3
  - platform: state
    entity_id: input_select.mj_status
    to: 'Just Arrived'
    for:
      minutes: 3
  - platform: state
    entity_id: input_select.josh_status
    from: 'Just Left'
    to: 'Just Arrived'
  - platform: state
    entity_id: input_select.mj_status
    from: 'Just Left'
    to: 'Just Arrived'
  action:
  - service: input_select.select_option
    data_template:
      entity_id: >
        {% if trigger.entity_id == 'input_select.josh_status' %}
          input_select.josh_status
        {% else %}
          input_select.mj_status
        {% endif %}
      option: Home

- id: just_left
  alias: Mark person as just left
  initial_state: True
  trigger:
  - platform: state
    entity_id: person.josh
    from: 'home'
    to: 'not_home'
  - platform: state
    entity_id: person.mj
    from: 'home'
    to: 'not_home'
  action:
  - service: input_select.select_option
    data_template:
      entity_id: >
        {% if trigger.entity_id == 'person.josh' %}
          input_select.josh_status
        {% else %}
          input_select.mj_status
        {% endif %}
      option: Just Left

- id: person_away
  alias: Mark person as away
  initial_state: True
  trigger:
  - platform: state
    entity_id: input_select.josh_status
    to: 'Just Left'
    for:
      minutes: 3
  - platform: state
    entity_id: input_select.mj_status
    to: 'Just Left'
    for:
      minutes: 3
  action:
  - service: input_select.select_option
    data_template:
      entity_id: >
        {% if trigger.entity_id == 'input_select.josh_status' %}
          input_select.josh_status
        {% else %}
          input_select.mj_status
        {% endif %}
      option: Away
  - service: notify.josh
    data_template:
      title: "Away"
      message:  >
        {% if states('input_select.josh_status') == 'Away'%}
          Josh is {{states.input_select.josh_status.state}} {{now().strftime('%H:%M %d-%b')}} via {{states.person.josh.attributes.source_type}}
        {% else %}
          MJ is {{states.input_select.mj_status.state}} {{now().strftime('%H:%M %d-%b')}} via {{states.person.josh.attributes.source_type}}
        {% endif %}

- id: extended_away
  alias: Mark person as extended away
  initial_state: True
  trigger:
  - platform: state
    entity_id: input_select.josh_status
    to: 'Away'
    for:
      hours: 24
  - platform: state
    entity_id: input_select.mj_status
    to: 'Away'
    for:
      hours: 24
  action:
  - service: input_select.select_option
    data_template:
      entity_id: >
        {% if trigger.entity_id == 'input_select.josh_status' %}
          input_select.josh_status
        {% else %}
          input_select.mj_status
        {% endif %}
      option: Extended Away
