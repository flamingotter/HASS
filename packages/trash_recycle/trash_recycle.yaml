#################################################################
#                                                               #
#                    Packages/Trash Recycle                     #
#                                                               #
#################################################################

#################################################################
#                                                               #
#                          Customize                            #
#                                                               #
#################################################################

homeassistant:
  customize:
    sensor.trash_day:
      friendly_name: Is it Trash Day today?
      icon: mdi:delete-variant
    sensor.trash_pickup_day:
      friendly_name: Trash Pickup Day
      icon: mdi:calendar-today
      hidden: true
    group.trash_recycle:
      friendly_name: Trash & Recycle
      icon: mdi:recycle

#################################################################
#                                                               #
#                           Group                               #
#                                                               #
#################################################################

group:
  trash schedule:
    name: Trash Schedule
    view: no
    entities:
      - sensor.trash_day
      - input_select.trash_reminders
      - sensor.trash_pickup_day
      - input_select.trash_pickup_day

#################################################################
#                                                               #
#                        User Inputs                            #
#                                                               #
#################################################################
##Input Selects

input_select:
  trash_pickup_day:
    name: Current Trash Pickup Day (Evey Week)
    options:
     - Monday
     - Tuesday
     - Wednesday
     - Thursday
     - Friday
     - Saturday
     - Sunday
    icon: mdi:delete-variant
  
  trash_reminders:
    name: Trash Reminder
    options:
     - Bins Taken Out
     - Remind Later
     - Reset Trash Reminders

##Input Booleans

input_boolean:
  trash_reminders:
    name: Trash Reminders
    initial: on
    icon: mdi:delete-variant

#################################################################
#                                                               #
#                           Sensors                             #
#                                                               #
#################################################################

sensor:

####################################################
#                                                  #
#                   Sensor - MQTT                  #
#                                                  #
####################################################

#   - platform: mqtt
#     state_topic: "/home/trashpickupday"
#     name: "Trash Pickup Day"
#     value_template: "{{ value }}"
#     qos: 1

####################################################
#                                                  #
#                 Sensor - Template                #
#                                                  #
####################################################

## Sensor to hold info about current week is an odd week or an even week of the year

  # - platform: template
  #   sensors:
  #     current_week:
  #       value_template: >-
  #         {% set year = states.sensor.date_time.state.split(',')[0].split('-')[0] %}
  #         {% set month = states.sensor.date_time.state.split(',')[0].split('-')[1] %}
  #         {% set date = states.sensor.date_time.state.split(',')[0].split('-')[2] %}
  #         {% set today = strptime(year ~ '-' ~ month ~ '-' ~ date , '%Y-%m-%d') %}
  #         {%- if (as_timestamp(today) | timestamp_custom('%U', true) | int ) % 2 == 0 -%}
  #           Even Week (Week# {{ as_timestamp(today) | timestamp_custom('%U', true) }})
  #         {%- else -%}
  #           Odd Week (Week# {{ as_timestamp(today) | timestamp_custom('%U', true) }})
  #         {%- endif -%}

## Trash  - Pickup schedule is EVERY week.
## Set the day to a day before the actual day leaving time for reminders

#   - platform: template
#     sensors:
#       trash_day:
#         value_template: >-
#           {% set year = states.sensor.date_time.state.split(',')[0].split('-')[0] %}
#           {% set month = states.sensor.date_time.state.split(',')[0].split('-')[1] %}
#           {% set date = states.sensor.date_time.state.split(',')[0].split('-')[2] %}
#           {% set today = strptime(year ~ '-' ~ month ~ '-' ~ date , '%Y-%m-%d') %}
#           {%- set pickupDay = states.sensor.trash_pickup_day.state | lower -%}
#           {%- if as_timestamp(today)| timestamp_custom('%A', true) | lower == pickupDay -%}
#             yes
#           {%- else -%}
#             no
#           {%- endif -%}

## Recycle - Pickup schedule is every other week.
## Set the day to a day before the actual day leaving time for reminders

#   - platform: template
#     sensors:
#       recycle_day:
#         value_template: >-
#           {% set year = states.sensor.date_time.state.split(',')[0].split('-')[0] %}
#           {% set month = states.sensor.date_time.state.split(',')[0].split('-')[1] %}
#           {% set date = states.sensor.date_time.state.split(',')[0].split('-')[2] %}
#           {% set today = strptime(year ~ '-' ~ month ~ '-' ~ date , '%Y-%m-%d') %}
#           {%- set pickupDay = states.sensor.recycle_pickup_day.state | lower -%}
#           {% if states.input_select.recycle_pickup_week.state | lower == "even weeks" %}
#             {%- set evenWeekPickup = "true" %}
#           {% else %}
#             {%- set evenWeekPickup = "false" %}
#           {% endif %}
#           {%- macro day_of_week(timestamp) -%}
#             {{ as_timestamp(timestamp)| timestamp_custom('%A', true) | lower }}
#           {%- endmacro %}
#           {%- macro week_number_of_year() -%}
#             {{ as_timestamp(today) | timestamp_custom('%U', true) | int }}
#           {%- endmacro %}
#           {%- macro is_it_this_week() -%}
#             {%- if as_timestamp(today) | timestamp_custom('%U', true) | int % 2 == 0 -%}
#               {%- if evenWeekPickup == "true" -%}
#                 true
#               {%- else -%}
#                 false
#               {%- endif -%}
#             {%- else -%}
#               {%- if evenWeekPickup == "true" -%}
#                 false
#               {%- else -%}
#                 true
#               {%- endif -%}
#             {%- endif -%}
#           {%- endmacro -%}
#           {%- macro is_it_today() -%}
#           {%- if is_it_this_week() == "true" -%}
#             {%- if day_of_week(today) | lower == pickupDay -%}
#               yes
#             {%- else -%}
#               no
#             {%- endif -%}
#           {%- else -%}
#             no
#           {%- endif -%}
#           {%- endmacro -%}
#           {{- is_it_today() -}}

## Set the day to a day before the actual day leaving time for reminders

#   - platform: template
#     sensors:

#       trash:
#         friendly_name: Trash
#         entity_id: sensor.trash_day
#         value_template: >-
#           {% if is_state('sensor.trash_day', 'yes') %}
#             100
#           {% elif is_state('sensor.trash_day', 'no') %}
#             0
#           {% endif %}

#################################################################
#                                                               #
#                       Binary Sensors                          #
#                                                               #
#################################################################

binary_sensor:

####################################################
#                                                  #
#             Binary Sensor - Template             #
#                                                  #
####################################################
  - platform: template
    sensors:
      trash_day:
        friendly_name: Trash Day?
        value_template: >-
          {{ states('sensor.dayoftheweek') == states('input_select.trash_pickup_day') }}

#       trash:
#         friendly_name: Trash
#         entity_id: sensor.trash_day
#         value_template: "{{ is_state('sensor.trash_day', 'yes') }}"
#         icon_template: >-
#           {% if is_state('sensor.trash_day', 'yes') %}
#             fas:trash-alt
#           {% elif is_state('sensor.trash_day', 'no') %}
#             fas:trash-alt
#           {% else %}
#             mdi:alert
#           {% endif %}

      # recycle:
      #   friendly_name: Recycle
      #   entity_id: sensor.recycle_day
      #   value_template: "{{ is_state('sensor.recycle_day', 'yes') }}"
      #   icon_template: >-
      #     {% if is_state('sensor.recycle_day', 'yes') %}
      #       fas:recycle
      #     {% elif is_state('sensor.recycle_day', 'no') %}
      #       fas:recycle
      #     {% else %}
      #       mdi:alert
      #     {% endif %}
      #
      # green:
      #   friendly_name: Green
      #   entity_id: sensor.green_day
      #   value_template: "{{ is_state('sensor.green_day', 'yes') }}"
      #   icon_template: >-
      #     {% if is_state('sensor.green_day', 'yes') %}
      #       mdi:leaf
      #     {% elif is_state('sensor.green_day', 'no') %}
      #       mdi:leaf
      #     {% else %}
      #       mdi:alert
      #     {% endif %}

#################################################################
#                                                               #
#                          Automations                          #
#                                                               #
#################################################################

## Some automations for this package have now been moved to Node-RED please see Node-Red Flows folder within this package for more infomation! ##

automation:

  - alias: Reset Trash Reminders
    initial_state: true
    hide_entity: true
    trigger:
      - platform: time
        at: '09:00:00'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.trash_reminders
      - service: input_select.select_option
        data_template:
          entity_id: input_select.trash_pickup_day
          option: "{{states.sensor.trash_pickup_day.state}}"
      # - service: input_select.select_option
      #   data_template:
      #     entity_id: input_select.recycle_pickup_day
      #     option: "{{states.sensor.recycle_pickup_day.state}}"
      # - service: input_select.select_option
      #   data_template:
      #     entity_id: input_select.recycle_pickup_week
      #     option: "{{states.sensor.recycle_pickup_week.state}}"
